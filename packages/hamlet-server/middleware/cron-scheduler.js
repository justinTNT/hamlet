/**
 * Cron Scheduler Service
 *
 * Reads cron-config.json (generated by BuildAmp from Config/Cron.elm)
 * and schedules events to be inserted into the buildamp_events table.
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import cron from 'node-cron';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

export default async function createCronScheduler(server) {
    console.log('â° Setting up Cron Scheduler');

    const scheduledJobs = new Map();
    let dbService = null;

    /**
     * Load cron config from generated file
     */
    function loadCronConfig() {
        const appName = server.config.application || 'horatio';
        const possiblePaths = [
            path.join(__dirname, `../../../app/${appName}/server/.generated/cron-config.json`),
            path.join(process.cwd(), 'server/.generated/cron-config.json'),
            path.join(process.cwd(), '.generated/cron-config.json')
        ];

        for (const configPath of possiblePaths) {
            if (fs.existsSync(configPath)) {
                try {
                    const content = fs.readFileSync(configPath, 'utf-8');
                    const config = JSON.parse(content);
                    console.log(`   ðŸ“‹ Loaded cron config from ${configPath}`);
                    return config;
                } catch (error) {
                    console.error(`   âŒ Error parsing cron config: ${error.message}`);
                }
            }
        }

        console.log('   âš ï¸  No cron-config.json found');
        return { events: [] };
    }

    /**
     * Schedule an event to be inserted into the events table
     */
    async function scheduleEvent(eventType, host = 'system') {
        if (!dbService) {
            dbService = server.getService('database');
        }

        try {
            const sql = `
                INSERT INTO buildamp_events (
                    application, host, event_type, payload, execute_at, priority
                ) VALUES ($1, $2, $3, $4, NOW(), $5)
                RETURNING id
            `;

            const params = [
                server.config.application || 'horatio',
                host,
                eventType,
                '{}',  // Empty payload for scheduled events
                'normal'
            ];

            const result = await dbService.query(sql, params);
            const eventId = result.rows[0].id;

            console.log(`   â° Scheduled event ${eventId}: ${eventType} (host: ${host})`);
            return eventId;
        } catch (error) {
            console.error(`   âŒ Failed to schedule event ${eventType}: ${error.message}`);
            return null;
        }
    }

    /**
     * Initialize scheduled jobs from config
     */
    function initializeJobs(config) {
        // Stop any existing jobs
        for (const [name, job] of scheduledJobs) {
            job.stop();
            console.log(`   ðŸ›‘ Stopped existing job: ${name}`);
        }
        scheduledJobs.clear();

        if (!config.events || config.events.length === 0) {
            console.log('   ðŸ“­ No cron events configured');
            return;
        }

        for (const cronEvent of config.events) {
            const { event, schedule } = cronEvent;

            // Validate cron expression
            if (!cron.validate(schedule)) {
                console.error(`   âŒ Invalid cron expression for ${event}: ${schedule}`);
                continue;
            }

            // Schedule the job
            const job = cron.schedule(schedule, async () => {
                console.log(`   â° Cron triggered: ${event}`);
                await scheduleEvent(event);
            }, {
                scheduled: true,
                timezone: process.env.TZ || 'UTC'
            });

            scheduledJobs.set(event, job);
            console.log(`   âœ… Scheduled ${event}: ${schedule}`);
        }

        console.log(`   ðŸ“… ${scheduledJobs.size} cron jobs active`);
    }

    // Load config and initialize
    const config = loadCronConfig();
    initializeJobs(config);

    const cronService = {
        /**
         * Get list of scheduled jobs
         */
        getScheduledJobs() {
            return Array.from(scheduledJobs.entries()).map(([name, job]) => ({
                name,
                running: job.running || false
            }));
        },

        /**
         * Manually trigger an event (for testing)
         */
        async triggerEvent(eventType, host = 'system') {
            return scheduleEvent(eventType, host);
        },

        /**
         * Reload config (for HMR)
         */
        reload() {
            console.log('   ðŸ”„ Reloading cron config');
            const newConfig = loadCronConfig();
            initializeJobs(newConfig);
        },

        /**
         * Stop all scheduled jobs
         */
        async cleanup() {
            console.log('ðŸ§¹ Cleaning up Cron Scheduler');
            for (const [name, job] of scheduledJobs) {
                job.stop();
            }
            scheduledJobs.clear();
        }
    };

    server.registerService('cron', cronService);
    return cronService;
}
