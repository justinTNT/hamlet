(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const t of o)if(t.type==="childList")for(const n of t.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function r(o){const t={};return o.integrity&&(t.integrity=o.integrity),o.referrerPolicy&&(t.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?t.credentials="include":o.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function i(o){if(o.ep)return;o.ep=!0;const t=r(o);fetch(o.href,t)}})();const l=window.Elm;console.log("Popup script loaded. Window.Elm:",window.Elm);chrome.tabs.query({active:!0,currentWindow:!0},s=>{console.log("Tabs query result:",s);const e=s[0];if(!e){console.log("No active tab found."),c({title:"",url:"",selection:"",images:[]});return}const r=e.url||"";if(r.startsWith("chrome://")||r.startsWith("chrome-extension://")||r.startsWith("about:")||r.startsWith("edge://")||r.startsWith("brave://")||r===""){console.log("Protected URL, skipping script injection:",r),c({title:e.title||"",url:r,selection:"",images:[]});return}chrome.scripting.executeScript({target:{tabId:e.id},func:()=>{const o=window.getSelection().toString(),t=Array.from(document.images).map(n=>n.src).filter(n=>n.startsWith("http"));return{selection:o,images:t}}},o=>{console.log("Script execution results:",o);let t={title:e.title||"",url:e.url||"",selection:"",images:[]};o&&o[0]&&o[0].result&&(t.selection=o[0].result.selection||"",t.images=o[0].result.images||[]),c(t)})});function c(s){console.log("Initializing Elm with flags:",s);try{const e=l.Popup.init({node:document.getElementById("app"),flags:s});console.log("Elm initialized successfully."),u(e)}catch(e){console.error("Failed to initialize Elm:",e)}}function u(s){s.ports.outbound.subscribe(function(e){const{apiUrl:r,payload:i}=e,o={...i,apiUrl:r};console.log("Popup sending message:",o),chrome.runtime.sendMessage(o,function(t){console.log("Popup received response:",t),chrome.runtime.lastError?(console.error("Runtime error:",chrome.runtime.lastError),s.ports.inbound.send({correlationId:i.correlationId,body:null,error:chrome.runtime.lastError.message})):s.ports.inbound.send(t)})}),s.ports.openAdmin.subscribe(function(e){let r=e.url.replace(/\/api\/?$/,"/admin");e.adminToken&&e.adminToken.trim()!==""&&(r+="?admin_token="+encodeURIComponent(e.adminToken)),console.log("Opening admin URL:",r),chrome.tabs.create({url:r})}),s.ports.saveHosts.subscribe(function(e){console.log("Saving hosts:",e),chrome.storage.local.set({hosts:e},function(){console.log("Hosts saved")})}),s.ports.loadHosts.subscribe(function(){console.log("Loading hosts..."),chrome.storage.local.get(["hosts"],function(e){console.log("Hosts loaded:",e.hosts),s.ports.hostsLoaded.send(e.hosts||[])})})}
