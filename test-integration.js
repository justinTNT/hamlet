#!/usr/bin/env node

/**
 * Simple Test for Hamlet Code Generation
 */

import fs from 'fs';

console.log('üß™ Hamlet Code Generation Simple Test');
console.log('=====================================\n');

let passed = 0;
let failed = 0;

function test(description, condition) {
    if (condition) {
        console.log(`‚úÖ ${description}`);
        passed++;
    } else {
        console.log(`‚ùå ${description}`);
        failed++;
    }
}

// Test file existence
console.log('üìÅ Checking generated files...');
test('API routes JS file exists', fs.existsSync('app/horatio/server/.hamlet-gen/api-routes.js'));
test('Database queries JS file exists', fs.existsSync('app/horatio/server/.hamlet-gen/database-queries.js'));
test('KV store JS file exists', fs.existsSync('app/horatio/server/.hamlet-gen/kv-store.js'));
test('Browser storage JS file exists', fs.existsSync('app/horatio/web/src/.hamlet-gen/browser-storage.js'));
test('Elm API client exists', fs.existsSync('app/horatio/web/src/.hamlet-gen/ApiClient.elm'));
test('Elm storage ports exist', fs.existsSync('app/horatio/web/src/.hamlet-gen/StoragePorts.elm'));

console.log('');

// Test content quality
console.log('üîç Checking content quality...');

if (fs.existsSync('app/horatio/server/.hamlet-gen/api-routes.js')) {
    const apiContent = fs.readFileSync('app/horatio/server/.hamlet-gen/api-routes.js', 'utf-8');
    test('API routes contains registerApiRoutes function', apiContent.includes('registerApiRoutes'));
    test('API routes contains Express endpoints', apiContent.includes('/api/'));
    test('API routes has warning header', apiContent.includes('DO NOT EDIT THIS FILE MANUALLY'));
}

if (fs.existsSync('app/horatio/web/src/.hamlet-gen/ApiClient.elm')) {
    const elmContent = fs.readFileSync('app/horatio/web/src/.hamlet-gen/ApiClient.elm', 'utf-8');
    test('Elm client has correct module declaration', elmContent.includes('module Generated.ApiClient'));
    test('Elm client has HTTP functions', elmContent.includes('Http.post'));
    test('Elm client has type aliases', elmContent.includes('type alias'));
    test('Elm client has encoders', elmContent.includes('Json.Encode'));
}

if (fs.existsSync('app/horatio/server/.hamlet-gen/kv-store.js')) {
    const kvContent = fs.readFileSync('app/horatio/server/.hamlet-gen/kv-store.js', 'utf-8');
    test('KV store has Redis operations', kvContent.includes('kvClient.setex'));
    test('KV store has tenant isolation', kvContent.includes('host}:'));
    test('KV store has error handling', kvContent.includes('try {') && kvContent.includes('catch (error)'));
}

console.log('');

// Summary
console.log('üìä Test Results:');
console.log(`‚úÖ Passed: ${passed}`);
console.log(`‚ùå Failed: ${failed}`);
console.log(`üìä Total: ${passed + failed}`);

if (failed === 0) {
    console.log('\nüéâ All tests passed!');
    console.log('üöÄ Hamlet code generation is working correctly!');
    console.log('');
    console.log('Generated outputs:');
    console.log('‚Ä¢ 4 JavaScript modules with type-safe functions');
    console.log('‚Ä¢ 2 Elm modules with HTTP client and storage ports');
    console.log('‚Ä¢ Complete "Rust once, JSON never" pipeline');
} else {
    console.log('\n‚ö†Ô∏è Some tests failed.');
    process.exit(1);
}